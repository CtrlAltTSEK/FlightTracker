<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>OR Tambo ‚Äì International Departures</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* --- Scale entire page for Hisense TV --- */
body {
    transform: scale(0.9);
    transform-origin: top left;
    width: 111.1%;
    height: 111.1%;
    background:#111;
    color:#eee;
    font-family:Arial, sans-serif;
    margin:0;
}

/* --- Header --- */
.header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:10px 20px;
    background:#222;
    height:100px;
    position: relative;
}
.header-left {
    display:flex;
    flex-direction: column;
    align-items: center;
    flex:1;
    justify-content:center;
    gap:10px;
}
.header-logo {
    position:absolute;
    left:20px;
    top:15px;
    height:70px;
    width:auto;
}
.header-left h1 {
    margin:0;
    font-size:2.5em;
    text-align:center;
}
#liveWeather { font-size:1.2em; font-weight:bold; padding:5px 10px; background:rgba(30,30,30,0.8); border-radius:5px; }

/* --- Table --- */
.table-wrapper { height:calc(100vh - 100px); display:flex; flex-direction:column; overflow:hidden; }
table { width:100%; border-collapse:collapse; font-size:18px; table-layout:fixed; }
thead { background:#000; position:sticky; top:0; z-index:2; }
thead th { padding:12px 8px; text-align:left; border-bottom:2px solid #2b2b2b; }
tbody td { padding:12px 8px; border-bottom:1px solid #2b2b2b; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
tbody tr:nth-child(even){ background:#141414; }

/* Column Width Control */
th.flight, td.flight { width: 100px; }
th.airline, td.airline { width: 220px; }
th.destination, td.destination { width: 400px; }
th.dep, td.dep { width: 180px; }

/* Flight Status */
.status-scheduled { color:#00bfff; font-weight:bold; }
.status-departed  { color:#32cd32; font-weight:bold; }
.status-enroute   { color:#ffa500; font-weight:bold; }
.status-arrived   { color:#32cd32; font-weight:bold; }
.status-delayed   { color:#ffa500; font-weight:bold; animation: blink 1s step-start infinite; }
.status-cancelled { color:#ff0000; font-weight:bold; animation: blink 0.8s step-start infinite; }
@keyframes blink { 0%,50%,100% {opacity:1;} 25%,75% {opacity:0;} }

/* Scrolling */
#scroll-body { flex:1; overflow:hidden; position:relative; }
#scroll-inner { display:inline-block; will-change: transform; }

@media (max-width:1024px){
    .header-left h1 { font-size:2em; }
    table { font-size:16px; }
    th.airline, td.airline { max-width:180px; }
    th.destination, td.destination { max-width:250px; }
}
@media (max-width:600px){
    .header-left h1 { font-size:1.5em; }
    table { font-size:14px; }
    th, td { padding:6px 4px; }
}
</style>
</head>
<body>

<div class="header">
    <img class="header-logo" src="https://cdn.freebiesupply.com/logos/large/2x/marriott-logo-png-transparent.png" alt="Marriott Logo">
    <div class="header-left">
        <h1>OR Tambo International ‚Äì International Departures</h1>
    </div>
    <div id="liveWeather">Loading Weather...</div>
</div>

<div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th class="flight">Flight</th>
        <th class="airline">Airline</th>
        <th class="destination">Destination</th>
        <th class="dep">Dep Date & Time</th>
        <th>Arrival</th>
        <th>Est. Flight</th>
        <th>Status</th>
      </tr>
    </thead>
  </table>

  <div id="scroll-body">
    <div id="scroll-inner">
      <table>
        <tbody id="departures-body"></tbody>
        <tbody id="departures-clone"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
// --- Airport Map ---
const airportMap = {
  "JNB":"O.R. Tambo International Airport","CPT":"Cape Town International Airport","DUR":"King Shaka International Airport",
  "MQP":"Mmabatho International Airport","UTN":"Upington Airport","PLZ":"Port Elizabeth Airport","BFN":"Bram Fischer International Airport",
  "GRJ":"George Airport","ELS":"East London Airport","PTG":"Polokwane International Airport","RCB":"Richards Bay Airport",
  "LHR":"London Heathrow","CDG":"Paris Charles de Gaulle","JFK":"John F. Kennedy International",
  "DXB":"Dubai International","HND":"Tokyo Haneda","SYD":"Sydney Kingsford Smith","MEL":"Melbourne Airport","FRA":"Frankfurt Airport",
  "AMS":"Amsterdam Schiphol","SIN":"Singapore Changi","BKK":"Bangkok Suvarnabhumi","HKG":"Hong Kong International",
  "NRT":"Tokyo Narita","ZNZ":"Zanzibar Abeid Amani Karume International","DOH":"Hamad International Airport","EBB":"Entebbe International Airport",
  "PER":"Perth Airport","EWR":"Newark Liberty International Airport","ATL":"Hartsfield‚ÄìJackson Atlanta International Airport",
  "DAR":"Dar es Salaam Julius Nyerere International Airport","ADD":"Addis Ababa Bole International Airport",
  "LAD":"Quatro de Fevereiro Airport","KGL":"Kigali International Airport","HRE":"Robert Gabriel Mugabe International Airport",
  "GBE":"Sir Seretse Khama International Airport","MPM":"Maputo International Airport","LUN":"Kenneth Kaunda International Airport",
  "ZRH":"Zurich Airport","RUN":"Roland Garros Airport","NBO":"Jomo Kenyatta International Airport",
  "FIH":"N‚Äôdjili Airport","WDH":"Hosea Kutako International Airport","UTT":"Upolu Airport",
  "SV":"Savannakhet Airport","AT":"Antananarivo Ivato Airport","KIM":"Kimberley Airport",
  "MSU":"Moshoeshoe I International Airport","SIS":"Sishen Airport","SHO":"King Shaka International Airport",
  "TET":"Chingozi","AUH":"Zayed Intl.","TNR":"Ivato Intl","SZK":"Skukuza Airport",
  "BUQ":"Joshua Mqabuko Nkomo International Airport","PZB":"Pietermaritzburg Airport",
  "VFA":"Victoria Falls Intl.","MRU":"Sir S. Ramgoolam Intl","NLA":"Simon M. Kapwepwe Intl",
  "FBM":"Luano Intl","WVB":"Walvis Bay Airport","MGH":"Margate Airport","SZX":"Bao'an Intl","HDS":"Hoedspruit"
};

// --- Airlines Map ---
const airlineMap = {
  "AA":"American Airlines","AF":"Air France","AI":"Air India","AY":"Finnair","AZ":"Alitalia",
  "BA":"British Airways","DL":"Delta Air Lines","EK":"Emirates","ET":"Ethiopian Airlines",
  "JL":"Japan Airlines","KL":"KLM Royal Dutch Airlines","LH":"Lufthansa","NZ":"Air New Zealand",
  "QR":"Qatar Airways","SA":"South African Airways","SQ":"Singapore Airlines","TK":"Turkish Airlines",
  "UA":"United Airlines","FA":"FlySafair","OZ":"Asiana Airlines","VS":"Virgin Atlantic",
  "VA":"Virgin Australia","CX":"Cathay Pacific","QF":"Qantas Airways","MH":"Malaysia Airlines",
  "IB":"Iberia","LX":"Swiss International","SN":"Brussels Airlines","FN":"Fastjet",
  "BP":"Air Botswana","TM":"LAM Mozambique Airlines","ZN":"Airlink","4Z":"Airlink",
  "6E":"IndiGo","AS":"Alaska Airlines","UR":"Tatarstan Airlines","WS":"WestJet",
  "MU":"China Eastern Airlines","LA":"LATAM Airlines","PK":"Pakistan International Airlines",
  "UL":"SriLankan Airlines","KP":"Kapit Airlines","SK":"Scandinavian Airlines","UU":"Asosa Airlines",
  "KQ":"Kenya Airways","DT":"Dadu Airlines","AC":"Air Canada","JU":"Air Serbia",
  "RJ":"Royal Jordanian","B6":"JetBlue Airways","WB":"Caribbean Airlines",
  "HC":"Coconut Island Airlines","5Z":"CemAir","P0":"Proflight Zambia","SV":"Saudia",
  "GE":"Global Aviation Operations","RN":"Eswatini Air",
  "CA":"Air China","CU":"Air China","ZH":"Shenzhen Airlines","MS":"EgyptAir",
  "MK":"Air Mauritius","KU":"Kuwait Airways","EY":"Etihad Airways","GF":"Gulf Air"
};

// --- Lookup helper (ensures uppercase matching) ---
function getAirlineName(iata){
  return airlineMap[(iata||"").toUpperCase()] || iata || "";
}

// --- South African Airports ---
const saAirports = [
  "JNB", "CPT", "DUR", "MQP", "UTN", "PLZ", "BFN", "GRJ", "ELS", "PTG",
  "RCB", "KIM", "SIS", "SHO", "PZB", "MGH", "HDS", "SZK"
];

// --- Weather ---
const lat=-26.1337, lon=28.2420;
async function fetchWeather(){
    try{
        const resp = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
        const data = await resp.json();
        const temp = Math.round(data.current_weather.temperature);
        const code = data.current_weather.weathercode;
        const icons = {0:"‚òÄÔ∏è",1:"üå§Ô∏è",2:"‚õÖ",3:"‚òÅÔ∏è",45:"üå´Ô∏è",48:"üå´Ô∏è",51:"üå¶Ô∏è",53:"üå¶Ô∏è",55:"üåßÔ∏è",61:"üåßÔ∏è",63:"üåßÔ∏è",65:"üåßÔ∏è",66:"üå®Ô∏è",67:"üå®Ô∏è",71:"‚ùÑÔ∏è",73:"‚ùÑÔ∏è",75:"‚ùÑÔ∏è",80:"üåßÔ∏è",81:"üåßÔ∏è",82:"‚õàÔ∏è",95:"‚õàÔ∏è",96:"‚õàÔ∏è",99:"‚õàÔ∏è"};
        const descs = {0:"Clear",1:"Mainly clear",2:"Partly cloudy",3:"Overcast",45:"Fog",48:"Rime fog",51:"Light drizzle",53:"Moderate drizzle",55:"Heavy drizzle",61:"Light rain",63:"Moderate rain",65:"Heavy rain",66:"Light freezing rain",67:"Heavy freezing rain",71:"Light snow",73:"Moderate snow",75:"Heavy snow",80:"Rain showers slight",81:"Moderate",82:"Violent",95:"Thunderstorm",96:"Thunderstorm w/ hail slight",99:"Thunderstorm w/ hail heavy"};
        const now = new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false, timeZone:'Africa/Johannesburg'});
        document.getElementById("liveWeather").textContent = `${icons[code]||"‚ùì"} ${temp}¬∞C, ${descs[code]||"Unknown"} | ${now}`;
    } catch(e){ console.error(e); document.getElementById("liveWeather").textContent="Weather unavailable"; }
}
fetchWeather();
setInterval(fetchWeather,60000);

// --- Departures ---
const API_KEY="24326bb2-4313-4dad-85f4-6ae08ad06866";
const departuresBody=document.getElementById("departures-body");
const departuresClone=document.getElementById("departures-clone");
const scrollInner=document.getElementById("scroll-inner");
const saAirports = ["JNB","CPT","DUR","MQP","UTN","PLZ","BFN","GRJ","ELS","PTG","RCB","KIM","SIS","SHO","PZB","MGH","HDS","SZK"];

function formatDuration(min){ if(min==null||isNaN(min)) return "‚Äî"; const h=Math.floor(min/60); const m=Math.floor(min%60); return h>0?`${h}h ${m}m`:`${m}m`; }

function getStatusClass(f){
    const now=new Date();
    const raw=(f.status||"").toLowerCase();
    const cancelled=["cancelled","canceled","cnx","c"].includes(raw) || f.cancelled || f.is_cancelled || (f.flight_status&&f.flight_status.toLowerCase()==="cancelled") || (f.status_iata && f.status_iata==="C");
    if(cancelled) return "cancelled";
    const delayed=["delayed","d","delay"].includes(raw) || (f.flight_status&&f.flight_status.toLowerCase()==="delayed") || (f.status_iata==="D");
    if(delayed) return "delayed";
    const depTime=f.dep_time?new Date(f.dep_time):null;
    const arrTime=f.arr_time?new Date(f.arr_time):null;
    if(arrTime && arrTime<=now) return "arrived";
    if(depTime && depTime<=now){ const mins=(now-depTime)/60000; return mins<=30?"departed":"enroute"; }
    return "scheduled";
}

async function fetchDepartures(){
    try{
        const resp = await fetch(`https://airlabs.co/api/v9/schedules?dep_iata=JNB&api_key=${API_KEY}&limit=200`);
        const data = await resp.json();
        let flights = (data.response||[]).filter(f=>f.arr_iata&&!saAirports.includes(f.arr_iata));
        flights.sort((a,b)=>new Date(a.dep_time)-new Date(b.dep_time));
        departuresBody.innerHTML="";
        if(flights.length===0){
            const row=document.createElement("tr");
            row.innerHTML=`<td colspan="7" style="text-align:center">No flights available</td>`;
            departuresBody.appendChild(row);
        } else {
            flights.forEach(f=>{
                const statusClass=getStatusClass(f);
                const depTime=f.dep_time?new Date(f.dep_time):null;
                const arrTime=f.arr_time?new Date(f.arr_time):null;
                const depLocal=depTime?depTime.toLocaleString('en-GB',{weekday:'short',day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit',hour12:false,timeZone:'Africa/Johannesburg'}):"‚Äî";
                const arrLocal=arrTime?arrTime.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',hour12:false,timeZone:'Africa/Johannesburg'}):"‚Äî";
                const est=formatDuration(depTime&&arrTime?(arrTime-depTime)/60000:null);
                const airlineName=airlineMap[f.airline_iata]||f.airline_iata||"";
                const destName=airportMap[f.arr_iata]||f.arr_iata;
                const row=document.createElement("tr");
                row.innerHTML=`
                    <td class="flight">${f.flight_iata||""}</td>
                    <td class="airline" title="${airlineName}">${airlineName}</td>
                    <td class="destination" title="${destName}">${destName}</td>
                    <td class="dep">${depLocal}</td>
                    <td>${arrLocal}</td>
                    <td>${est}</td>
                    <td class="status-${statusClass}">${statusClass.charAt(0).toUpperCase()+statusClass.slice(1)}</td>
                `;
                departuresBody.appendChild(row);
            });
        }
        setupScroll();
    } catch(err){ console.error(err); }
}

function setupScroll(){
    if(departuresBody.children.length===0) return;
    departuresClone.innerHTML = departuresBody.innerHTML;
    const scrollHeight = departuresBody.offsetHeight;
    const speed = 25; // pixels per second
    const duration = (scrollHeight*2)/speed; // full loop with clone
    scrollInner.style.animation = `scroll ${duration}s linear infinite`;
}

const styleSheet = document.createElement("style");
styleSheet.innerHTML = `@keyframes scroll { 0% { transform:translateY(0); } 100% { transform:translateY(-50%); } }`;
document.head.appendChild(styleSheet);

fetchDepartures();
setInterval(fetchDepartures,600000);
</script>

</body>
</html>

